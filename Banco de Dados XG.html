<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Trades Live</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Configuração de Fonte -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937;
        }
        /* Estilos do Modal para permitir scroll interno sem afetar a página */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto; /* Permite scroll dentro do modal */
            padding: 24px;
        }
        .loading-ring {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="appContainer" class="p-4 sm:p-6 lg:p-8">
    <!-- O conteúdo do aplicativo (Login/App) será renderizado aqui -->
</div>

<script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Variáveis Globais de Estado
    let state = {
        user: null,
        trades: [],
        activeTab: 'data', // 'data', 'dashboard'
        loading: false,
        authLoading: true,
        loginForm: { email: '', password: '' },
        tradeForm: {
            gameName: '', date: '', xgHome: '', xgAway: '',
            shotsHtHome: '', shotsHtAway: '', dutchingPercent: '', lay0x1Percent: '',
            isActive: true, // Novo trade é sempre ativo
        },
        exitForm: {
            tradeId: null,
            placarFinal: '',
            goalMinute: '',
            goalTeam: 'Casa',
            dutchingExit: '',
            dutchingExitMinute: '',
            layExit: '',
            layExitMinute: '',
            lucroInicialXG: '',
            custoProtecao: '',
            placaresAdicionais: '',
        },
        timeline: {}, // Para armazenar PnL de 5 em 5 minutos
        viewingTimelineTrade: null, // Trade atual para visualizar a timeline
        isEditingTrade: false, // Flag para saber se está editando ou registrando saída
        isSavingExit: false, // Flag para evitar cliques duplicados no salvamento de saída
    };

    // Variáveis Globais de Configuração (SEUS DADOS)
    // ATENÇÃO: Se estiver usando o ambiente Canvas, você deve usar as variáveis __app_id e __firebase_config.
    // Neste caso, estamos usando o seu JSON de configuração.
    const firebaseConfig = {
        apiKey: "AIzaSyDVizv6h_LtzJmssiKZdzLI0sgRiudHmeM",
        authDomain: "xglay0x1.firebaseapp.com",
        projectId: "xglay0x1",
        storageBucket: "xglay0x1.firebasestorage.app",
        messagingSenderId: "184643794187",
        appId: "1:184643794187:web:5ba997ea06861539249e0e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Variáveis de Configuração de Análise de IA
    const ENABLE_GEMINI_AI = true; // Flag para ligar/desligar a IA
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;

    // Caminho da Coleção
    const getCollectionRef = (userId) => {
        const appId = firebaseConfig.projectId;
        return collection(db, `artifacts/${appId}/users/${userId}/trades`);
    };

    // --- FUNÇÕES DE UTILIDADE ---

    const updateState = (newState) => {
        state = { ...state, ...newState };
        renderApp();
    };

    const isFormValid = (form) => {
        return form.gameName && form.date &&
               form.xgHome !== '' && form.xgAway !== '' &&
               form.shotsHtHome !== '' && form.shotsHtAway !== '' &&
               form.dutchingPercent !== '' && form.lay0x1Percent !== '';
    };

    const getExitColorClass = (value) => {
        if (!value || isNaN(parseFloat(value))) return 'text-gray-500';
        const num = parseFloat(value.replace('%', '').trim());
        if (num > 0) return 'text-green-600 font-bold';
        if (num < 0) return 'text-red-600 font-bold';
        return 'text-gray-500';
    };

    const formatXG = (xgHome, xgAway) => {
        const h = parseFloat(xgHome) || 0;
        const a = parseFloat(xgAway) || 0;
        return `${h.toFixed(2)} x ${a.toFixed(2)}`;
    };

    const createInput = (label, name, value, type = 'text', required = false, className = '', min = '', max = '') => {
        return `
            <div class="flex flex-col mb-3">
                <label for="${name}" class="text-gray-600 font-semibold text-xs mb-1">${label}</label>
                <input
                    type="${type}"
                    name="${name}"
                    id="${name}"
                    value="${value}"
                    ${required ? 'required' : ''}
                    min="${min}"
                    max="${max}"
                    class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm ${className}"
                    oninput="window.handleTradeFormChange(event)"
                >
            </div>
        `;
    };

    // --- FUNÇÕES DE FIREBASE (CRUD) ---

    const startTradeListener = (userId) => {
        if (!userId) return;

        const tradesRef = getCollectionRef(userId);
        const q = query(tradesRef, orderBy('date', 'desc'));

        onSnapshot(q, (snapshot) => {
            const tradesData = [];
            snapshot.forEach((doc) => {
                tradesData.push({ id: doc.id, ...doc.data() });
            });
            updateState({ trades: tradesData, loading: false });
        }, (error) => {
            console.error("Erro ao carregar trades:", error);
            updateState({ loading: false });
        });
    };

    const handleAddTrade = async () => {
        if (!state.user || state.loading || !isFormValid(state.tradeForm)) return;

        updateState({ loading: true });

        try {
            const newTrade = {
                ...state.tradeForm,
                createdAt: new Date().toISOString(),
                date: state.tradeForm.date, // Preserva a data como string
                xgHome: parseFloat(state.tradeForm.xgHome),
                xgAway: parseFloat(state.tradeForm.xgAway),
                shotsHtHome: parseInt(state.tradeForm.shotsHtHome),
                shotsHtAway: parseInt(state.tradeForm.shotsHtAway),
                dutchingPercent: parseFloat(state.tradeForm.dutchingPercent),
                lay0x1Percent: parseFloat(state.tradeForm.lay0x1Percent),
                isActive: true,
                exit: null,
            };

            await addDoc(getCollectionRef(state.user.uid), newTrade);

            // Limpa o formulário após o sucesso
            updateState({
                tradeForm: {
                    gameName: '', date: state.tradeForm.date, xgHome: '', xgAway: '',
                    shotsHtHome: '', shotsHtAway: '', dutchingPercent: '', lay0x1Percent: '',
                    isActive: true,
                },
                loading: false
            });

        } catch (error) {
            console.error("Erro ao adicionar trade:", error);
            alert("Erro ao adicionar trade: " + error.message);
            updateState({ loading: false });
        }
    };
    window.handleAddTrade = handleAddTrade;

    const handleDeleteTrade = async (tradeId) => {
        if (!state.user) return;
        if (!confirm("Tem certeza que deseja excluir este trade?")) return;

        try {
            await deleteDoc(doc(getCollectionRef(state.user.uid), tradeId));
            // O listener de onSnapshot atualizará o estado automaticamente
        } catch (error) {
            console.error("Erro ao excluir trade:", error);
            alert("Erro ao excluir trade: " + error.message);
        }
    };
    window.handleDeleteTrade = handleDeleteTrade;

    const handleSaveExit = async () => {
        if (!state.user || state.isSavingExit) return;

        const { tradeId, placarFinal, goalMinute, goalTeam, dutchingExit, dutchingExitMinute, layExit, layExitMinute, lucroInicialXG, custoProtecao, placaresAdicionais } = state.exitForm;

        // Validação básica
        if (!placarFinal || !dutchingExit || !dutchingExitMinute || !layExit || !layExitMinute || !lucroInicialXG || !custoProtecao) {
             alert("Preencha todos os campos obrigatórios da saída.");
             return;
        }

        updateState({ isSavingExit: true });

        try {
            const tradeRef = doc(getCollectionRef(state.user.uid), tradeId);
            const tradeSnapshot = await getDoc(tradeRef);

            if (!tradeSnapshot.exists()) {
                alert("Trade não encontrado para atualização.");
                updateState({ isSavingExit: false });
                return;
            }

            const currentTrade = tradeSnapshot.data();

            // Formata o PnL da timeline
            const timelineData = {};
            for (const key in state.timeline) {
                if (key.startsWith('dutchingPnl')) {
                    timelineData[key] = parseFloat(state.timeline[key]) || 0;
                } else if (key.startsWith('layPnl')) {
                    timelineData[key] = parseFloat(state.timeline[key]) || 0;
                }
            }

            const updatedExitData = {
                placarFinal,
                goalMinute: parseInt(goalMinute) || 0,
                goalTeam,
                dutchingExit: parseFloat(dutchingExit),
                dutchingExitMinute: parseInt(dutchingExitMinute),
                layExit: parseFloat(layExit),
                layExitMinute: parseInt(layExitMinute),
                lucroInicialXG: parseFloat(lucroInicialXG),
                custoProtecao: parseFloat(custoProtecao),
                placaresAdicionais,
                timeline: timelineData,
                closedAt: new Date().toISOString(),
            };

            const updatedTrade = {
                ...currentTrade,
                isActive: false, // Fecha o trade
                exit: updatedExitData,
            };

            // Se for edição, também atualiza os dados iniciais do trade (se necessário)
            if (state.isEditingTrade) {
                const updatedInitialData = {
                    gameName: state.tradeForm.gameName,
                    date: state.tradeForm.date,
                    xgHome: parseFloat(state.tradeForm.xgHome),
                    xgAway: parseFloat(state.tradeForm.xgAway),
                    shotsHtHome: parseInt(state.tradeForm.shotsHtHome),
                    shotsHtAway: parseInt(state.tradeForm.shotsHtAway),
                    dutchingPercent: parseFloat(state.tradeForm.dutchingPercent),
                    lay0x1Percent: parseFloat(state.tradeForm.lay0x1Percent),
                };
                Object.assign(updatedTrade, updatedInitialData);
            }

            await setDoc(tradeRef, updatedTrade);

            // Limpa o estado e fecha o modal
            updateState({
                exitForm: { tradeId: null, placarFinal: '', goalMinute: '', goalTeam: 'Casa', dutchingExit: '', dutchingExitMinute: '', layExit: '', layExitMinute: '', lucroInicialXG: '', custoProtecao: '', placaresAdicionais: '' },
                timeline: {},
                isEditingTrade: false,
                isSavingExit: false,
            });

        } catch (error) {
            console.error("Erro ao salvar saída:", error);
            alert("Erro ao salvar saída: " + error.message);
            updateState({ isSavingExit: false });
        }
    };
    window.handleSaveExit = handleSaveExit;

    // --- FUNÇÕES DE AUTENTICAÇÃO ---

    const handleAuthChange = async (e) => {
        updateState({
            loginForm: {
                ...state.loginForm,
                [e.target.name]: e.target.value
            }
        });
    };
    window.handleAuthChange = handleAuthChange;

    const handleLogin = async (isSignUp) => {
        const { email, password } = state.loginForm;
        if (state.authLoading || !email || !password) return;

        updateState({ authLoading: true });

        try {
            if (isSignUp) {
                await createUserWithEmailAndPassword(auth, email, password);
                alert("Conta criada com sucesso! Você está logado.");
            } else {
                await signInWithEmailAndPassword(auth, email, password);
            }
            // onAuthStateChanged cuidará da atualização do estado
        } catch (error) {
            console.error("Erro de autenticação:", error);
            alert(`Erro: ${error.message}`);
            updateState({ authLoading: false });
        }
    };
    window.handleLogin = handleLogin;

    const handleLogout = async () => {
        try {
            await signOut(auth);
            updateState({ trades: [] }); // Limpa os trades ao sair
        } catch (error) {
            console.error("Erro ao sair:", error);
        }
    };
    window.handleLogout = handleLogout;

    // Listener de Autenticação
    onAuthStateChanged(auth, (user) => {
        if (user) {
            updateState({ user, authLoading: false });
            startTradeListener(user.uid);
        } else {
            updateState({ user: null, authLoading: false, loading: false });
        }
        renderApp();
    });


    // --- FUNÇÕES DE RENDERIZAÇÃO ---

    const renderAuth = () => {
        const { email, password } = state.loginForm;
        const buttonDisabled = state.authLoading;

        return `
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md">
                    <h2 class="text-2xl font-bold text-center mb-6 text-indigo-600">Login / Cadastro - XG Logger</h2>
                    <div class="space-y-4">
                        <input
                            type="email"
                            name="email"
                            placeholder="Email"
                            value="${email}"
                            oninput="window.handleAuthChange(event)"
                            class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                            required
                        />
                        <input
                            type="password"
                            name="password"
                            placeholder="Senha"
                            value="${password}"
                            oninput="window.handleAuthChange(event)"
                            class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                            required
                        />
                    </div>
                    <div class="mt-6 space-y-3">
                        <button
                            onclick="window.handleLogin(false)"
                            class="w-full p-3 text-white bg-indigo-600 rounded-md font-semibold hover:bg-indigo-700 transition duration-150 ${buttonDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${buttonDisabled ? 'disabled' : ''}
                        >
                            ${state.authLoading ? '<div class="loading-ring mx-auto"></div>' : 'Login'}
                        </button>
                        <button
                            onclick="window.handleLogin(true)"
                            class="w-full p-3 text-indigo-600 bg-indigo-100 rounded-md font-semibold hover:bg-indigo-200 transition duration-150 ${buttonDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${buttonDisabled ? 'disabled' : ''}
                        >
                            Cadastrar
                        </button>
                    </div>
                </div>
            </div>
        `;
    };

    // --- Funções de manipulação de modal ---

    // Função de manipulação de input do formulário principal
    const handleTradeFormChange = (e) => {
        updateState({
            tradeForm: {
                ...state.tradeForm,
                [e.target.name]: e.target.value
            }
        });
        // Renderiza o formulário novamente para atualizar o estado do botão
        document.getElementById('tradeFormContainer').innerHTML = renderTradeForm();
    };
    window.handleTradeFormChange = handleTradeFormChange;


    // Função de manipulação de input do modal de saída
    const handleExitFormChangeModal = (e) => {
        const { name, value } = e.target;
        // Previne o scroll da página ao digitar
        // e.preventDefault(); // Comentado para não interferir no fluxo de digitação em certos navegadores

        // Limita inputs numéricos
        let val = value;
        if (e.target.type === 'number') {
            val = val.replace(/[^0-9.-]/g, ''); // Permite números, ponto e sinal de menos
        }

        updateState({
            exitForm: {
                ...state.exitForm,
                [name]: val
            }
        });

        // Força a atualização do modal para refletir o bloqueio dinâmico
        renderExitModal();
    };
    window.handleExitFormChangeModal = handleExitFormChangeModal;


    // Função de manipulação de input do PnL da timeline
    const handleTimelineChange = (e) => {
        const { name, value } = e.target;
        // e.preventDefault(); // Comentado para não interferir no fluxo de digitação em certos navegadores

        let val = value;
        if (e.target.type === 'number') {
            val = val.replace(/[^0-9.-]/g, ''); // Permite números, ponto e sinal de menos
        }

        updateState({
            timeline: {
                ...state.timeline,
                [name]: val
            }
        });

        // Força a atualização do modal para refletir a mudança
        renderExitModal();
    };
    window.handleTimelineChange = handleTimelineChange;


    const openExitModal = (trade) => {
        updateState({
            exitForm: {
                ...state.exitForm,
                tradeId: trade.id,
                placarFinal: trade.exit?.placarFinal || '',
                goalMinute: trade.exit?.goalMinute || '',
                goalTeam: trade.exit?.goalTeam || 'Casa',
                dutchingExit: trade.exit?.dutchingExit || '',
                dutchingExitMinute: trade.exit?.dutchingExitMinute || '',
                layExit: trade.exit?.layExit || '',
                layExitMinute: trade.exit?.layExitMinute || '',
                lucroInicialXG: trade.exit?.lucroInicialXG || '',
                custoProtecao: trade.exit?.custoProtecao || '',
                placaresAdicionais: trade.exit?.placaresAdicionais || '',
            },
            timeline: trade.exit?.timeline || {}, // Carrega dados da timeline se existirem
            tradeForm: { // Carrega dados iniciais para edição
                gameName: trade.gameName,
                date: trade.date,
                xgHome: trade.xgHome,
                xgAway: trade.xgAway,
                shotsHtHome: trade.shotsHtHome,
                shotsHtAway: trade.shotsHtAway,
                dutchingPercent: trade.dutchingPercent,
                lay0x1Percent: trade.lay0x1Percent,
            },
            isEditingTrade: true, // Modo de Edição/Saída
            isSavingExit: false,
        });
        renderExitModal();
    };
    window.openExitModal = openExitModal;

    const closeExitModal = () => {
        updateState({
            exitForm: { tradeId: null, placarFinal: '', goalMinute: '', goalTeam: 'Casa', dutchingExit: '', dutchingExitMinute: '', layExit: '', layExitMinute: '', lucroInicialXG: '', custoProtecao: '', placaresAdicionais: '' },
            timeline: {},
            isEditingTrade: false,
        });
        document.getElementById('modalContainer').innerHTML = '';
    };
    window.closeExitModal = closeExitModal;

    const openTimelineModal = (trade) => {
        updateState({ viewingTimelineTrade: trade });
        renderTimelineModal();
    };
    window.openTimelineModal = openTimelineModal;

    const closeTimelineModal = () => {
        updateState({ viewingTimelineTrade: null });
        document.getElementById('timelineModalContainer').innerHTML = '';
    };
    window.closeTimelineModal = closeTimelineModal;


    // --- RENDERIZAÇÃO DE COMPONENTES ---

    const renderTradeForm = () => {
        const { gameName, date, xgHome, xgAway, shotsHtHome, shotsHtAway, dutchingPercent, lay0x1Percent } = state.tradeForm;
        const isButtonDisabled = state.loading || !isFormValid(state.tradeForm);

        return `
            <div id="tradeFormContainer" class="bg-white p-4 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Novo Registro de Trade (0x0)</h3>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${createInput('Jogo (Time Casa v Visitante)', 'gameName', gameName, 'text', true)}
                    ${createInput('Data', 'date', date, 'date', true)}
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-6 gap-4 mt-4">
                    ${createInput('XG Casa', 'xgHome', xgHome, 'number', true, 'text-center', '0', '10')}
                    ${createInput('XG Visitante', 'xgAway', xgAway, 'number', true, 'text-center', '0', '10')}
                    ${createInput('Chutes Casa', 'shotsHtHome', shotsHtHome, 'number', true, 'text-center', '0', '50')}
                    ${createInput('Chutes Fora', 'shotsHtAway', shotsHtAway, 'number', true, 'text-center', '0', '50')}
                    ${createInput('Dutching (%)', 'dutchingPercent', dutchingPercent, 'number', true, 'text-center', '0', '100')}
                    ${createInput('Lay 0x1 (%)', 'lay0x1Percent', lay0x1Percent, 'number', true, 'text-center', '0', '100')}
                </div>

                <button
                    onclick="window.handleAddTrade()"
                    class="w-full mt-6 p-3 text-white font-semibold rounded-md transition duration-150 ${isButtonDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}"
                    ${isButtonDisabled ? 'disabled' : ''}
                >
                    ${state.loading ? '<div class="loading-ring mx-auto"></div>' : 'Adicionar Trade'}
                </button>
                ${!state.user && state.authLoading === false ? '<p class="text-center mt-3 text-red-500 text-sm">Faça login para adicionar trades.</p>' : ''}
            </div>
        `;
    };

    const renderTradeTable = () => {
        const openTrades = state.trades.filter(t => t.isActive);
        const closedTrades = state.trades.filter(t => !t.isActive);
        const allTrades = [...openTrades, ...closedTrades];

        const generateRow = (trade, isClosed) => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';

            const addCell = (content, className = '') => {
                const cell = row.insertCell();
                cell.className = `p-2 text-xs ${className}`;
                cell.innerHTML = content;
                return cell;
            };

            // Jogo
            addCell(`<span class="font-medium">${trade.gameName}</span><br><span class="text-gray-500">${trade.date}</span>`);
            // XG (C x V)
            addCell(formatXG(trade.xgHome, trade.xgAway), 'text-center');
            // Chutes (C x V)
            addCell(`${trade.shotsHtHome} x ${trade.shotsHtAway}`, 'text-center');
            // Dutching % / Lay 0x1 %
            addCell(`D: ${trade.dutchingPercent}%<br>L: ${trade.lay0x1Percent}%`, 'text-center');

            if (isClosed && trade.exit) {
                // Evento de Saída
                addCell(`
                    ${trade.exit.goalMinute ? `<span class="font-semibold text-sm">${trade.exit.goalMinute}'</span>` : ''}
                    ${trade.exit.goalTeam ? `(${trade.exit.goalTeam})` : ''}
                    <br><span class="text-gray-500">${trade.exit.placarFinal}</span>
                `, 'text-center');

                // Saída Dutching
                addCell(`
                    <span class="${getExitColorClass(trade.exit.dutchingExit)}">${trade.exit.dutchingExit}%</span>
                    <br><span class="text-gray-500 text-xs">${trade.exit.dutchingExitMinute}'</span>
                `, 'text-center');
                 // Saída Lay
                addCell(`
                    <span class="${getExitColorClass(trade.exit.layExit)}">${trade.exit.layExit}%</span>
                    <br><span class="text-gray-500 text-xs">${trade.exit.layExitMinute}'</span>
                `, 'text-center');

                // Ações
                addCell(`
                    <div class="flex space-x-2 justify-center">
                        <button onclick="window.openExitModal({ id: '${trade.id}', ...${JSON.stringify(trade)} })" class="text-blue-600 hover:text-blue-800 text-xs font-semibold">Editar</button>
                        <button onclick="window.openTimelineModal(${JSON.stringify(trade).replace(/"/g, '&quot;')})" class="text-indigo-600 hover:text-indigo-800 text-xs font-semibold">Ver PnL</button>
                        <button onclick="window.handleDeleteTrade('${trade.id}')" class="text-red-600 hover:text-red-800 text-xs font-semibold">Excluir</button>
                    </div>
                `, 'text-center');

            } else {
                 // Ações
                addCell('<span class="text-gray-500">—</span>', 'text-center');
                addCell('<span class="text-gray-500">—</span>', 'text-center');
                addCell('<span class="text-gray-500">—</span>', 'text-center');

                addCell(`
                    <div class="flex space-x-2 justify-center">
                        <button onclick="window.openExitModal({ id: '${trade.id}', ...${JSON.stringify(trade)} })" class="text-green-600 hover:text-green-800 text-xs font-semibold">Registrar Saída</button>
                        <button onclick="window.handleDeleteTrade('${trade.id}')" class="text-red-600 hover:text-red-800 text-xs font-semibold">Excluir</button>
                    </div>
                `, 'text-center');
            }
        };

        const table = document.createElement('div');
        table.className = 'bg-white p-4 rounded-lg shadow-md overflow-x-auto';
        table.innerHTML = `
            <h3 class="text-xl font-bold mb-4 text-gray-800">Histórico de Trades (${allTrades.length})</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jogo / Data</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">XG (C x V)</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Chutes HT</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Risco Inicial</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Evento Saída</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Saída Dutch.</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Saída Lay</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                    </tr>
                </thead>
                <tbody id="tradeTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        `;

        const tbody = table.querySelector('#tradeTableBody');

        try {
            allTrades.forEach(trade => {
                // Determina se o trade está fechado ou ativo
                const isClosed = trade.exit && trade.exit.placarFinal;
                generateRow(trade, isClosed, tbody);
            });
        } catch (error) {
            console.error("Erro ao renderizar linha da tabela:", error);
            // Adiciona uma linha de erro
            const errorRow = tbody.insertRow();
            const errorCell = errorRow.insertCell();
            errorCell.colSpan = 8;
            errorCell.className = "text-center py-4 text-red-500 font-semibold";
            errorCell.textContent = "Erro ao carregar dados. Tente recarregar.";
        }

        return table.outerHTML;
    };

    const renderDataTab = () => {
        return `
            <div id="dataTabContent" class="space-y-6">
                ${renderTradeForm()}
                ${renderTradeTable()}
            </div>
        `;
    };


    const renderExitModal = () => {
        const { tradeId, placarFinal, goalMinute, goalTeam, dutchingExit, dutchingExitMinute, layExit, layExitMinute, lucroInicialXG, custoProtecao, placaresAdicionais } = state.exitForm;
        const trade = state.trades.find(t => t.id === tradeId);
        const isButtonDisabled = state.isSavingExit;

        // --- Lógica Dinâmica de Bloqueio ---
        const isGoalFromHome = goalTeam === 'Casa';
        const isGoalMinuteSet = parseInt(goalMinute) > 0;
        const isLay0x1Finished = isGoalMinuteSet && isGoalFromHome;

        const minutes = Array.from({ length: 10 }, (_, i) => 45 + i * 5); // 45, 50, ..., 90

        const renderExitForm = () => {
            return `
                <div class="space-y-4">
                    <!-- Dados Iniciais (Apenas se em modo de edição) -->
                    ${state.isEditingTrade ? `
                        <h4 class="text-md font-bold mb-3 text-indigo-600">Edição dos Dados Iniciais</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                             ${createInput('XG Casa', 'xgHome', state.tradeForm.xgHome, 'number', true, 'text-center', '0', '10')}
                             ${createInput('XG Visitante', 'xgAway', state.tradeForm.xgAway, 'number', true, 'text-center', '0', '10')}
                             ${createInput('Dutching %', 'dutchingPercent', state.tradeForm.dutchingPercent, 'number', true, 'text-center', '0', '100')}
                             ${createInput('Lay 0x1 %', 'lay0x1Percent', state.tradeForm.lay0x1Percent, 'number', true, 'text-center', '0', '100')}
                        </div>
                        <hr class="my-4 border-gray-200">
                    ` : ''}


                    <!-- Evento de Saída -->
                    <h4 class="text-md font-bold mb-3 text-indigo-600">Evento e Saída Final</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Placar Final</label>
                            <input type="text" name="placarFinal" value="${placarFinal}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Ex: 1 - 1" required>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Minuto do GOL</label>
                            <input type="number" name="goalMinute" value="${goalMinute}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Minuto" min="45" max="90">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Time que Marcou</label>
                            <select name="goalTeam" value="${goalTeam}" onchange="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="Casa" ${goalTeam === 'Casa' ? 'selected' : ''}>Casa</option>
                                <option value="Fora" ${goalTeam === 'Fora' ? 'selected' : ''}>Fora (Zebra)</option>
                                <option value="Nenhum" ${goalTeam === 'Nenhum' ? 'selected' : ''}>Nenhum (0x0)</option>
                            </select>
                        </div>
                    </div>

                    <h4 class="text-md font-bold mb-3 mt-6 text-indigo-600">Lucro/Red e Tempo de Saída</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Saída Dutching (%)</label>
                            <input type="number" name="dutchingExit" value="${dutchingExit}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="+/- %" required>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Minuto da Saída Dutch.</label>
                            <input type="number" name="dutchingExitMinute" value="${dutchingExitMinute}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Minuto" min="45" max="95" required>
                        </div>
                         <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Saída Lay 0x1 (%)</label>
                            <input type="number" name="layExit" value="${layExit}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="+/- %" required>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Minuto da Saída Lay 0x1</label>
                            <input type="number" name="layExitMinute" value="${layExitMinute}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Minuto" min="45" max="95" required>
                        </div>
                    </div>

                    <!-- Transferência de Lucro / Custos -->
                    <h4 class="text-md font-bold mb-3 mt-6 text-indigo-600">Transferência de Lucro / Custos</h4>
                     <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Lucro Inicial XG (%)</label>
                            <input type="number" name="lucroInicialXG" value="${lucroInicialXG}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Ex: 30" required>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-gray-600 font-semibold text-xs mb-1">Custo Proteção (%)</label>
                            <input type="number" name="custoProtecao" value="${custoProtecao}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Custo de proteção" required>
                        </div>
                        <div class="flex flex-col col-span-2">
                             <label class="text-gray-600 font-semibold text-xs mb-1">Placares Protegidos Adicionais (Ex: 3x0, 2x2)</label>
                            <input type="text" name="placaresAdicionais" value="${placaresAdicionais}" oninput="window.handleExitFormChangeModal(event)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Opcional">
                        </div>
                    </div>


                    <h4 class="text-md font-bold mb-3 mt-6 text-indigo-600">Timeline PnL (Lucro/Red a cada 5 Minutos)</h4>
                    <p class="text-xs text-red-500 mb-3">${isLay0x1Finished ? `⚠️ Lay 0x1 Bloqueado após ${goalMinute}' (Gol da Casa)` : ''}</p>

                    <div class="grid grid-cols-5 gap-3 text-center text-xs font-semibold text-gray-700">
                        <div>Minuto</div>
                        <div>Dutching PnL (%)</div>
                        <div>Lay 0x1 PnL (%)</div>
                    </div>

                    ${minutes.map(minute => {
                        const dutchName = `dutchingPnl${minute}`;
                        const layName = `layPnl${minute}`;
                        // Bloqueio dinâmico: se houve gol da casa ANTES ou NO minuto atual
                        const isDisabled = isLay0x1Finished && (minute >= parseInt(goalMinute));
                        const layValue = isDisabled ? 'N/A' : (state.timeline[layName] || '');
                        const layInputClass = isDisabled ? 'bg-gray-100 cursor-not-allowed' : '';

                        return `
                            <div class="grid grid-cols-5 gap-3 items-center mb-1">
                                <div class="col-span-1">${minute}'</div>
                                <input type="number" name="${dutchName}" value="${state.timeline[dutchName] || ''}" oninput="window.handleTimelineChange(event)" placeholder="%" class="col-span-2 p-1 border rounded-md text-xs text-center" />
                                <input type="text" name="${layName}" value="${layValue}" oninput="window.handleTimelineChange(event)" placeholder="%" class="col-span-2 p-1 border rounded-md text-xs text-center ${layInputClass}" ${isDisabled ? 'disabled' : ''}/>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        document.getElementById('modalContainer').innerHTML = `
            <div class="modal-overlay">
                <div class="modal-content w-full sm:w-3/4 lg:w-2/3 xl:w-1/2">
                    <h3 class="text-xl font-bold mb-4 text-indigo-600">${state.isEditingTrade ? `Editar Trade: ${trade?.gameName}` : 'Registrar Saída'}</h3>

                    ${renderExitForm()}

                    <div class="flex justify-end space-x-4 mt-6">
                        <button onclick="window.closeExitModal()" class="p-2 px-4 bg-gray-200 text-gray-800 rounded-md font-semibold hover:bg-gray-300 transition duration-150">
                            Cancelar
                        </button>
                        <button onclick="window.handleSaveExit()" class="p-2 px-4 text-white bg-green-600 rounded-md font-semibold hover:bg-green-700 transition duration-150 ${isButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${isButtonDisabled ? 'disabled' : ''}>
                             ${state.isEditingTrade ? 'Salvar Edição / Saída' : 'Registrar Saída'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    };

    const renderTimelineModal = () => {
        const trade = state.viewingTimelineTrade;
        if (!trade || !trade.exit || !trade.exit.timeline) return;

        const minutes = Array.from({ length: 10 }, (_, i) => 45 + i * 5);
        const timeline = trade.exit.timeline;

        const renderPnlValue = (value) => {
            if (value === 'N/A' || !value) return '<span class="text-gray-400">N/A</span>';
            const num = parseFloat(value);
            return `<span class="${getExitColorClass(num)}">${num.toFixed(1)}%</span>`;
        };

        document.getElementById('timelineModalContainer').innerHTML = `
            <div class="modal-overlay">
                <div class="modal-content w-full sm:w-1/2">
                    <h3 class="text-xl font-bold mb-4 text-indigo-600">Timeline PnL: ${trade.gameName}</h3>

                    <p class="mb-4 text-sm">Dados de Lucro/Red para cada método em faixas de 5 minutos. Evento de Saída: <span class="font-semibold">${trade.exit.placarFinal}</span> no minuto <span class="font-semibold">${trade.exit.goalMinute}'</span> (${trade.exit.goalTeam})</p>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Minuto</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Dutching PnL</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Lay 0x1 PnL</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${minutes.map(minute => {
                                    const dutchValue = timeline[`dutchingPnl${minute}`];
                                    const layValue = timeline[`layPnl${minute}`];
                                    return `
                                        <tr>
                                            <td class="p-2 text-center text-sm font-semibold">${minute}'</td>
                                            <td class="p-2 text-center text-sm">${renderPnlValue(dutchValue)}</td>
                                            <td class="p-2 text-center text-sm">${renderPnlValue(layValue)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button onclick="window.closeTimelineModal()" class="p-2 px-4 bg-gray-200 text-gray-800 rounded-md font-semibold hover:bg-gray-300 transition duration-150">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        `;
    };

    // --- FUNÇÕES DE DASHBOARD/IA ---

    const renderDashboardTab = () => {
        // Filtra trades fechados com dados válidos de saída
        const closedTrades = state.trades.filter(t => !t.isActive && t.exit);
        const validDutchingExits = closedTrades.filter(t => t.exit.dutchingExitMinute > 0);

        let totalPnLDutching = 0;
        let totalTrades = validDutchingExits.length;
        let totalWins = 0;
        let totalRed = 0;
        let sumMinutes = 0;
        let totalMinutesCount = 0;

        validDutchingExits.forEach(trade => {
            const pnl = trade.exit.dutchingExit;
            totalPnLDutching += pnl;

            if (pnl > 0) {
                totalWins++;
            } else if (pnl < 0) {
                totalRed++;
            }

            if (trade.exit.dutchingExitMinute > 0) {
                sumMinutes += trade.exit.dutchingExitMinute;
                totalMinutesCount++;
            }
        });

        const winRate = totalTrades > 0 ? (totalWins / totalTrades) * 100 : 0;
        const avgExitMinute = totalMinutesCount > 0 ? sumMinutes / totalMinutesCount : 0;

        // PnL Acumulado (Para o Gráfico)
        let accumulatedPnL = 0;
        const pnlData = validDutchingExits.map((trade, index) => {
            accumulatedPnL += trade.exit.dutchingExit;
            return {
                x: index + 1, // Trade Number
                y: parseFloat(accumulatedPnL.toFixed(2)),
                label: trade.gameName
            };
        });

        const dashboardHTML = `
            <div class="space-y-8">
                <h3 class="text-2xl font-bold text-gray-800">Dashboard de Performance (Dutching)</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">PnL Total</p>
                        <p class="text-2xl font-bold ${getExitColorClass(totalPnLDutching)}">${totalPnLDutching.toFixed(2)}%</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Winrate (Dutch.)</p>
                        <p class="text-2xl font-bold text-gray-800">${winRate.toFixed(1)}%</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Trades Fechados</p>
                        <p class="text-2xl font-bold text-gray-800">${totalTrades}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Minuto Saída Médio</p>
                        <p class="text-2xl font-bold text-gray-800">${avgExitMinute.toFixed(0)}'</p>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold mb-3">PnL Acumulado (Dutching)</h4>
                        <canvas id="pnlChart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold mb-3">Win/Loss Rate</h4>
                        <canvas id="winLossChart"></canvas>
                    </div>
                </div>

                <!-- Análise IA -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-indigo-600">XG IA</h3>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="aiQuery" placeholder="Pergunte sobre média de XG, lucro por minuto, etc." class="p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 flex-grow" />
                        <button onclick="window.handleAIQuery()" class="p-3 text-white bg-indigo-600 rounded-md font-semibold hover:bg-indigo-700 transition duration-150" id="aiButton">
                            Analisar
                        </button>
                    </div>
                    <div id="aiResponse" class="mt-4 p-4 border border-gray-200 rounded-md bg-gray-50 whitespace-pre-wrap">
                        Aguardando sua pergunta...
                    </div>
                </div>
            </div>
        `;
        return dashboardHTML;
    };

    const handleAIQuery = async () => {
        if (!ENABLE_GEMINI_AI) {
             document.getElementById('aiResponse').innerHTML = `<span class="text-red-500">⚠️ A integração da IA está desativada no momento (ENABLE_GEMINI_AI = false).</span>`;
             return;
        }

        const query = document.getElementById('aiQuery').value;
        const button = document.getElementById('aiButton');
        const responseDiv = document.getElementById('aiResponse');

        if (!query) return;

        button.disabled = true;
        responseDiv.innerHTML = '<div class="loading-ring mx-auto my-4"></div>';

        // 1. Prepara os dados para a IA (apenas trades fechados para análise)
        const tradesToAnalyze = state.trades.filter(t => !t.isActive && t.exit);
        if (tradesToAnalyze.length === 0) {
             responseDiv.innerHTML = '<span class="text-red-500">Não há trades fechados com dados de saída para analisar.</span>';
             button.disabled = false;
             return;
        }

        const tradesJSON = JSON.stringify(tradesToAnalyze, null, 2);

        // 2. Cria o System Prompt
        const systemPrompt = `
            Você é um analista de trading esportivo de alta gerência, especializado em estratégias de Dutching baseadas em Expected Goals (XG).
            Sua tarefa é analisar os dados de trades (fornecidos em JSON) para responder a perguntas em linguagem natural de forma concisa e profissional.

            Instruções CRÍTICAS:
            1. Formatação: Omita os passos de cálculo. Use listas Markdown e parágrafos concisos.
            2. Análise do Valor: Para médias de lucro/red por minuto, analise o campo 'exit.timeline'.
            3. XG por Equipe: Para responder sobre a média de XG de uma equipe específica, filtre os trades pelo 'gameName' (ex: 'Flamengo v Fluminense') e calcule a média dos campos 'xgHome' e 'xgAway'.
            4. Lucro/Red: Use apenas 'dutchingExit' e 'layExit' para PnL final. Use '+' ou '-' para indicar lucro/red.
            5. Pessoa: Responda em tom profissional e direto, focando em insights estatísticos.
        `;

        // 3. Monta o Payload da API
        const payload = {
            contents: [{ parts: [{ text: `Analise os seguintes dados e responda a pergunta do usuário:\n\nDados JSON:\n${tradesJSON}\n\nPergunta do Usuário: ${query}` }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            tools: [{ "google_search": {} }],
        };

        const fetchWithRetry = async (url, options, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // Exponential backoff handled above
                }
            }
        };

        try {
            const apiUrl = `${GEMINI_API_URL}${firebaseConfig.apiKey}`;
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao processar a resposta da IA. Tente novamente.";

            responseDiv.innerHTML = `<span class="whitespace-pre-wrap">${text}</span>`;
        } catch (error) {
            console.error("Erro na chamada da API Gemini:", error);
            responseDiv.innerHTML = `<span class="text-red-500">Erro de conexão com a IA. Verifique sua chave API e conexão de rede: ${error.message}</span>`;
        } finally {
            button.disabled = false;
        }
    };
    window.handleAIQuery = handleAIQuery;


    // --- FUNÇÕES GERAIS DE RENDERIZAÇÃO ---

    const renderApp = () => {
        const appContainer = document.getElementById('appContainer');

        if (state.authLoading && !state.user) {
            appContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="flex items-center space-x-3">
                        <div class="loading-ring"></div>
                        <p class="text-lg font-semibold text-gray-600">Carregando autenticação...</p>
                    </div>
                </div>
            `;
            return;
        }

        if (!state.user) {
            appContainer.innerHTML = renderAuth();
            return;
        }

        // Renderização do Aplicativo Principal (Logado)
        const renderMainApp = () => {
            return `
                <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-md">
                    <h1 class="text-3xl font-extrabold text-indigo-700">Banco de Dados de Trades Live</h1>
                    <div class="flex space-x-4 items-center">
                        <span class="text-sm font-medium text-gray-600 hidden sm:block">Usuário: ${state.user.email}</span>
                        <button onclick="window.handleLogout()" class="p-2 px-4 bg-red-500 text-white rounded-md font-semibold text-sm hover:bg-red-600 transition duration-150">
                            Sair
                        </button>
                    </div>
                </div>

                <!-- Abas de Navegação -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-4">
                        <button
                            onclick="updateState({ activeTab: 'data' })"
                            class="py-2 px-4 font-semibold text-sm transition duration-150 ${state.activeTab === 'data' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}"
                        >
                            Registro de Trades
                        </button>
                        <button
                            onclick="updateState({ activeTab: 'dashboard' })"
                            class="py-2 px-4 font-semibold text-sm transition duration-150 ${state.activeTab === 'dashboard' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}"
                        >
                            Dashboard & Análise IA
                        </button>
                    </nav>
                </div>

                <!-- Conteúdo das Abas -->
                <div id="tabContent">
                    ${state.activeTab === 'data' ? renderDataTab() : renderDashboardTab()}
                </div>

                <!-- Modais -->
                <div id="modalContainer"></div>
                <div id="timelineModalContainer"></div>
            `;
        };
        appContainer.innerHTML = renderMainApp();

        // Renderiza Gráficos após o DOM estar pronto
        if (state.activeTab === 'dashboard') {
            const closedTrades = state.trades.filter(t => !t.isActive && t.exit);
            const validDutchingExits = closedTrades.filter(t => t.exit.dutchingExitMinute > 0);

            // 1. PnL Acumulado
            let accumulatedPnL = 0;
            const pnlData = validDutchingExits.map((trade, index) => {
                accumulatedPnL += trade.exit.dutchingExit;
                return {
                    x: index + 1, // Trade Number
                    y: parseFloat(accumulatedPnL.toFixed(2)),
                    label: trade.gameName
                };
            });

            const pnlChartCtx = document.getElementById('pnlChart');
            if (pnlChartCtx) {
                new Chart(pnlChartCtx, {
                    type: 'line',
                    data: {
                        labels: pnlData.map(d => d.x),
                        datasets: [{
                            label: 'PnL Acumulado (%)',
                            data: pnlData.map(d => d.y),
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: 'Número do Trade' } },
                            y: { title: { display: true, text: 'PnL Acumulado (%)' } }
                        }
                    }
                });
            }

            // 2. Win/Loss Rate
            let totalWins = closedTrades.filter(t => t.exit.dutchingExit > 0).length;
            let totalLosses = closedTrades.filter(t => t.exit.dutchingExit < 0).length;
            let totalBreakeven = closedTrades.filter(t => t.exit.dutchingExit === 0).length;
            let totalClosed = closedTrades.length;

            const winLossChartCtx = document.getElementById('winLossChart');
            if (winLossChartCtx) {
                new Chart(winLossChartCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Ganhos (GREEN)', 'Perdas (RED)', 'Zero (Break-Even)'],
                        datasets: [{
                            data: [totalWins, totalLosses, totalBreakeven],
                            backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: false }
                        }
                    }
                });
            }
        }
    };

    // --- Inicialização do App ---
    renderApp();

</script>
<!-- Containers para os Modais -->
<div id="modalContainer"></div>
<div id="timelineModalContainer"></div>
</body>
</html>

